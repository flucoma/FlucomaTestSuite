TestFluidMDS : FluidUnitTest {
	classvar reducedarray_target;
	classvar reducedarray2_target;

	*initClass {
		reducedarray_target = [ [ -6.0501989748822, 2.3296686980703 ], [ 0.88262356560919, 6.7386382241982 ], [ -3.9467160255546, -3.7656617815442 ], [ 1.0631016844277, -1.3432358340395 ], [ 14.778122779143, -2.1538286841055 ], [ 6.1496990934834, 7.4594924836653 ], [ -3.0308903112686, -2.4260726965776 ], [ -2.2144186323614, -1.0596038079907 ], [ 3.6483573674352, 5.4462378186461 ], [ 8.257586708751, -2.4227503557683 ], [ 1.3502444143753, 0.55197888648483 ], [ -3.5079888901572, 0.030445287313084 ], [ -0.115575486361, 8.264575888719 ], [ 4.665146359977, 5.3434590144897 ], [ -0.79092442422714, -1.0009089338996 ], [ -2.3552115499351, 2.76171253573 ], [ 3.1778537959633, -3.1964121279003 ], [ 14.246401015771, -2.0223389369154 ], [ 13.314811490003, -3.1427839002527 ], [ 10.175785493455, -1.988626646589 ], [ 4.298401751921, 6.5434670278597 ], [ -5.8865326859043, -3.7073769832132 ], [ -7.0681573097559, -2.302109676912 ], [ 3.3242843598676, 5.4404239800665 ], [ -5.6991471038842, -3.8130515118039 ], [ -6.4889076726799, -0.48454061643875 ], [ 1.5492755233255, 3.0412837186703 ], [ -6.4324638227201, -3.2789098761466 ], [ -7.0384697090947, -1.4388774149276 ], [ -1.5027640907033, 7.8393713105318 ], [ 1.4547178737263, -2.524511246012 ], [ 11.777798907677, -0.3879646542025 ], [ 13.010517867447, 0.28262411102277 ], [ 4.996949129768, -3.2666155262562 ], [ -6.0636627873968, -2.9823110535022 ], [ 7.8437237565786, 4.1566100617863 ], [ 13.927225498747, -3.3419749839244 ], [ 10.609855076413, 1.6603151625562 ], [ -0.36228313421197, -3.9334731029806 ], [ -6.1191961839817, -3.105141456541 ], [ 10.442838315402, -2.9229496473675 ], [ 3.3495082039936, -4.361610500995 ], [ -5.0257023666827, -3.3286455239952 ], [ 1.1994773264847, 0.34112982938663 ], [ 8.0816244251362, 1.1019765692556 ], [ -4.7190783349947, -3.2727431144538 ], [ -6.8806866799075, -1.9475671067698 ], [ -6.7741378455186, -0.317583536342 ], [ 12.851821491644, -3.9828261844305 ], [ -3.5277442381002, -2.5576136348244 ], [ 0.97821580923638, 7.92804800165 ], [ -4.4925115773129, -2.8446684820569 ], [ -6.8020833633254, -2.3272040337911 ], [ -4.6717238868959, 0.41508053326371 ], [ 14.072515517489, -3.3358226253667 ], [ 0.016453530036454, -4.6397012225009 ], [ -6.3178375366957, -2.4053415341591 ], [ -3.9885286601628, 4.6013432482216 ], [ -0.50372034857114, 2.7047074329646 ], [ -5.8388279222187, -2.6134350749815 ], [ -2.6295810554669, 5.7279522943165 ], [ 14.503936536092, -2.8793456092266 ], [ 11.73167489314, -0.9247439973725 ], [ -3.1867135513573, -0.033363611662624 ], [ -2.8775645216627, 2.8609744747008 ], [ -6.9114190486718, -2.6737902077711 ], [ -6.1309023627516, -1.1444076542747 ], [ -7.1005469432066, -2.2578879697608 ], [ -6.4251895902237, 0.60130601317782 ], [ -3.365515210886, 1.2053751046751 ], [ -4.2208434196377, -1.0423884984453 ], [ -1.2864567350016, 6.9081530332876 ], [ -3.8612812034813, -2.2638937075786 ], [ -4.0944307065633, 3.9918206655617 ], [ -4.5633326361615, -0.089414262106627 ], [ -1.0503388684671, 6.2886792849061 ], [ -6.6520924041615, -2.7693095214073 ], [ -5.2838350594176, -1.3053752578494 ], [ 12.557143475829, -2.2778463240533 ], [ 1.4231544258467, 1.7819663688351 ], [ -6.4830424313903, -3.1397927904096 ], [ -0.93205801251483, 8.5187418588528 ], [ -2.2171910827493, 2.5954827594321 ], [ -6.5607520162008, -2.1452334146615 ], [ -6.7353398985712, -0.83785304648278 ], [ 14.021048587832, -3.504365706135 ], [ 13.24956936112, -0.74524705837692 ], [ 1.5495040915386, -4.5573045213382 ], [ -5.6711237143696, -2.9045915997933 ], [ -5.5999902332106, -1.9459536318672 ], [ -3.3793707538657, 6.1880891414591 ], [ -5.799533413549, -3.6045387782785 ], [ -4.2719422945066, -0.13531787259002 ], [ -5.0147854262351, -1.6655510470353 ], [ -4.8733545088, 3.8148829530167 ], [ -2.4919281606211, -0.6491161831125 ], [ 0.64467408528453, 8.7614180888821 ], [ -3.4335618620881, -2.616780722296 ], [ -1.3260306486236, 4.3684820560022 ], [ -6.5295042600883, -0.53570689729414 ] ];

		reducedarray2_target = [ [ -1054.5288448084, 169.05582546092 ], [ 154.16937283043, 838.10103581534 ], [ -378.63070303462, -610.40604322224 ], [ 560.34009014159, -379.1909099214 ], [ 2018.120111814, -126.26173291308 ], [ 736.05563655009, 1118.3930815767 ], [ -359.08728614883, -449.48199461087 ], [ -443.30973186222, -279.4307389382 ], [ 605.28652182552, 736.07144513576 ], [ 1438.6242965407, -177.63037420781 ], [ 104.74223055271, 30.918797297684 ], [ -729.91784729227, 12.799372075885 ], [ -46.015501246565, 1060.8971935844 ], [ 759.06177590254, 750.57400927505 ], [ 36.47025948407, -339.95268198114 ], [ -556.27776836635, 334.56453703588 ], [ 1038.7852674769, -466.27465578892 ], [ 1923.6944726537, -120.75705045638 ], [ 1923.6266887367, -190.06896424452 ], [ 1564.5728310285, -114.08050207323 ], [ 570.91982647468, 942.76797408225 ], [ -764.43735158377, -421.7418873742 ], [ -1022.0106392248, -263.6188362207 ], [ 528.58717849771, 649.82663316532 ], [ -773.79014114214, -462.31475472369 ], [ -950.54345509005, -128.37382924327 ], [ 422.97983212353, 318.06518005441 ], [ -794.6045328582, -376.7540369279 ], [ -1027.6521759492, -203.89756917623 ], [ -461.40355405832, 892.78615027074 ], [ 437.94351737383, -417.11491855618 ], [ 1611.6065202627, 220.43954063268 ], [ 1826.3391160247, 225.09925014529 ], [ 1165.1802250961, -485.12811640736 ], [ -875.63146226573, -276.54988160727 ], [ 1045.3884588797, 697.15136908463 ], [ 1912.3764427855, -276.47665618656 ], [ 1525.3131318505, 377.91546818504 ], [ -19.338322215975, -651.58806754242 ], [ -907.61500586024, -301.03754290829 ], [ 1524.2940396146, -410.80795105409 ], [ 904.23816361467, -618.38031983615 ], [ -511.75902787031, -499.77275093774 ], [ 792.76374154205, 7.7796531622939 ], [ 1301.4989573807, 273.67783110653 ], [ -484.15407773745, -495.83069589265 ], [ -950.5591728517, -211.98993687957 ], [ -987.30045622439, 23.7361895487 ], [ 1832.156207102, -506.6700034796 ], [ -527.63929984777, -377.17134172074 ], [ -176.01402993778, 1074.0570334797 ], [ -574.75520021238, -381.993142849 ], [ -948.18589086029, -236.80492157814 ], [ -771.46513664195, 82.144378234042 ], [ 1896.1761062692, -408.93932391238 ], [ 170.54513472021, -719.9938315536 ], [ -881.70878399146, -227.89303847418 ], [ -886.32437303351, 528.64207946514 ], [ 32.148234486216, 342.76605466035 ], [ -784.55535485268, -342.19495110767 ], [ -722.44492064875, 593.66700187423 ], [ 1887.9882680485, -249.16095732819 ], [ 1693.7457421197, -67.577809614102 ], [ -399.36474195693, -101.64226903407 ], [ -499.37730264506, 442.9883996862 ], [ -965.79568215423, -270.47613286931 ], [ -888.87344259709, -161.74033376509 ], [ -875.62933403023, -323.28196505998 ], [ -1032.8437331315, 133.98611340245 ], [ -607.04422985333, 172.29427726351 ], [ -667.19660603605, -147.17322248555 ], [ -519.49990123913, 754.08329777574 ], [ -472.73823076542, -446.42051854752 ], [ -842.03008479288, 486.88637695819 ], [ -763.88319573082, 10.389119377095 ], [ -295.41045162301, 700.63043763369 ], [ -833.21447929508, -372.12002468026 ], [ -683.67186336791, -249.51135484787 ], [ 1668.3610473151, -237.81470497959 ], [ 444.92217599349, 237.31982590513 ], [ -967.70532908785, -323.10491444191 ], [ -438.20498356315, 965.64123593665 ], [ -447.33253964178, 432.92426943942 ], [ -867.69192393714, -344.48913206487 ], [ -1011.0806236899, -158.35214608566 ], [ 1931.8566014505, -452.08497541171 ], [ 1822.7215466872, 131.57337448949 ], [ 464.72890630396, -706.71825833827 ], [ -837.13394538468, -318.30334203056 ], [ -811.47017233255, -324.21297916229 ], [ -845.32322268674, 622.51482116799 ], [ -779.7081574822, -445.29781580806 ], [ -717.09536587347, 18.774724611393 ], [ -672.38568296054, -168.97485497493 ], [ -996.84825506989, 321.15482413111 ], [ -271.67426890225, 15.831285287491 ], [ -231.46798404192, 1140.0084160789 ], [ -485.79457156444, -456.19575098278 ], [ -237.50066476544, 506.03949346749 ], [ -941.67765963382, -113.70996000097 ] ];
	}

	test_mfcc {
		var condition = Condition();
		var audiofile = File.realpath(FluidBufPitch.class.filenameSymbol).dirname +/+ "../AudioFiles/Tremblay-ASWINE-ScratchySynth-M.wav";
		var raw = FluidDataSet(server);
		var standardized = FluidDataSet(server);
		var reduced = FluidDataSet(server);
		var audio = Buffer.read(server,audiofile);
		var mfcc_feature = Buffer.new(server);
		var stats_buf = Buffer.alloc(server, 7, 12);
		var standardizer  = FluidStandardize(server);
		var mds = FluidMDS(server);

		var synth;
		var reducedarray, reducedarray2;

		FluidBufMFCC.process(server,audio, features: mfcc_feature).wait;

		//run synth
		synth = {
			var trig = LocalIn.kr(1, 1);
			var buf =  LocalBuf(12, 1);
			var count = PulseCount.kr(trig) - 1;
			var chunkLen = (mfcc_feature.numFrames / 100).asInteger;
			var stats = FluidBufStats.kr(
				source: mfcc_feature, startFrame: count * chunkLen,
				startChan:1, numFrames: chunkLen, stats: stats_buf, trig: trig, blocking:1
			);
			var rd = BufRd.kr(12, stats_buf, DC.kr(0), 0, 1);
			var bufWr, dsWr;
			12.do{|i|
				bufWr = BufWr.kr(rd[i], buf, DC.kr(i));
			};
			dsWr = FluidDataSetWr.kr(raw, buf: buf, idNumber: count, trig: Done.kr(stats),blocking:1);
			LocalOut.kr(Done.kr(dsWr));
			FreeSelf.kr(count - 99);
			Poll.kr(trig,(100-count));
		}.play(server);

		synth.onFree({ condition.unhang });

		"TestFluidMDS: Stats processing. This can take some time...".warn;

		condition.hang;

		reducedarray = Array.new(100);
		standardizer.fitTransform(raw, standardized);
		mds.fitTransform(standardized, reduced, action:{
			reduced.dump{|x|
				var data = x["data"];
				result[\mds_size] = TestResult(data.size, 100);
				100.do{|i|
					reducedarray = reducedarray.add(data[i.asString])
				};
				condition.unhang;
			}
		});

		condition.hang;

		result[\reducedarray] = TestResultEquals(reducedarray, reducedarray_target, 0.0001);

		mds.distanceMetric = FluidMDS.kl;

		server.sync;

		reducedarray2 = Array.new(100);
		mds.fitTransform(standardized, reduced, action:{
			reduced.dump{|x|
				var data = x["data"];
				result[\mds2_size] = TestResult(data.size, 100);
				100.do{|i|
					reducedarray2 = reducedarray2.add(data[i.asString])
				};
				condition.unhang;
			}
		});

		condition.hang;

		result[\reducedarray2] = TestResultEquals(reducedarray2, reducedarray2_target, 0.0001);

		server.sync;
		raw.free;
		standardized.free;
		reduced.free;
		standardizer.free;
		mds.free;
	}
}