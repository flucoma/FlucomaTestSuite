TestFluidPCA : FluidUnitTest {
	classvar reducedarray_target;

	*initClass {
		reducedarray_target = [ [ 2.7634406895916, -0.67866026889847 ], [ 0.30971704641996, -2.8118519169002 ], [ 0.96944190976745, 1.8509311477305 ], [ -0.59201734657224, 0.60220555613268 ], [ -6.2080632966176, 0.11662924744604 ], [ -1.7880437248266, -4.6878583265354 ], [ 0.86532970365306, 1.2601110215871 ], [ 0.67692646456524, 0.65313561533392 ], [ -0.88762076423902, -2.5030001513173 ], [ -3.1071725154777, 0.95254918554646 ], [ 0.056324333290528, -0.012528345455183 ], [ 1.4616378419551, 0.29840103573347 ], [ 1.3730320363503, -4.2286501709728 ], [ -1.2651608891623, -2.6148835459648 ], [ 0.61047392572512, 0.91264942753254 ], [ 0.97685999221273, -0.91262071102548 ], [ -1.3632332252558, 1.4705697508793 ], [ -5.7496668573066, 0.077024018815593 ], [ -5.6144458418002, 1.1103577852864 ], [ -3.7683251924263, 0.48856986657267 ], [ -0.99796659390384, -3.3975306049375 ], [ 1.8350505586056, 1.9352721488206 ], [ 2.4813170344746, 1.3030276226844 ], [ -0.70560025354219, -2.536178021415 ], [ 1.8375508704013, 2.1017605346306 ], [ 2.1906130703986, 0.38831020179724 ], [ -0.32574285862167, -1.2218811702249 ], [ 1.9112364703579, 1.6253654016161 ], [ 2.5092709986924, 0.88827962777432 ], [ 1.6708219232645, -3.4966902632322 ], [ -0.69468449747235, 1.323120971122 ], [ -4.1912341013686, -0.66375261692469 ], [ -4.9125751700856, -1.3141572250296 ], [ -1.9687470173335, 1.6027537795898 ], [ 1.8141187055704, 1.4485097404986 ], [ -2.6011292742752, -2.6421625451359 ], [ -5.7790363002436, 1.1749666598976 ], [ -3.6889339721784, -1.6734854222278 ], [ -0.11875057070169, 2.0875179410275 ], [ 1.9453135696683, 1.5965898055688 ], [ -3.8000198433546, 1.0584343030286 ], [ -1.4442001324088, 2.537739792736 ], [ 1.4368149147308, 1.648197423903 ], [ -0.54824888044544, -0.13331884282948 ], [ -2.8505872627662, -0.90536237552674 ], [ 1.3242867290398, 1.6105621402145 ], [ 2.1698480573366, 1.0046857101051 ], [ 2.4104175047887, 0.37347335210658 ], [ -5.3040785201396, 1.7604993824867 ], [ 0.98844668569847, 1.3123478522049 ], [ 1.1229317915448, -4.8458207015595 ], [ 1.1705945922941, 1.3335013333226 ], [ 2.1520462469146, 1.2284150977128 ], [ 1.40403513, -0.00832268165384 ], [ -5.6720763118763, 1.0483270859228 ], [ -0.26847460450545, 2.5609664932301 ], [ 1.8483228604736, 1.1514578613418 ], [ 2.1883604199511, -1.7899741610069 ], [ 0.54829115022745, -1.1752148160179 ], [ 1.6806624373358, 1.2818999700025 ], [ 1.5253852488585, -2.0948934665891 ], [ -5.9633309204811, 0.67148117628364 ], [ -4.2705365129771, -0.27041466768912 ], [ 0.95746033305648, 0.15045899850091 ], [ 1.1526628948848, -1.0073884129723 ], [ 2.2072887893939, 1.3820087744552 ], [ 1.899927847783, 0.63316189148572 ], [ 2.3218516121415, 1.2027160226536 ], [ 2.4592292396707, 0.036579627561136 ], [ 1.3093991660342, -0.21808493950038 ], [ 1.6409514917853, 0.83395565778002 ], [ 1.384276619179, -2.8970530710014 ], [ 1.2850101010464, 1.3110376962071 ], [ 1.9764427613591, -1.3760467311061 ], [ 1.5398404522875, 0.28311309535195 ], [ 1.0112012517008, -2.453272085319 ], [ 2.1435726476906, 1.4841564166818 ], [ 1.4696944330469, 0.64850122097756 ], [ -4.8660777815958, 0.43549432747197 ], [ -0.40381752885062, -0.68940122689251 ], [ 2.1894576993047, 1.7278361219089 ], [ 1.6307495429531, -3.9886598681407 ], [ 0.90900114743536, -0.92540332241469 ], [ 2.2996860671515, 1.2387474016314 ], [ 2.435283135098, 0.61818135769187 ], [ -5.9229073406197, 1.2968620691795 ], [ -4.9528284543438, -0.64458116366316 ], [ -0.83316991724904, 2.5329004844875 ], [ 1.7852335638957, 1.5296382112696 ], [ 1.860204623835, 1.1253606176626 ], [ 2.0600665200433, -2.3704169244599 ], [ 1.8678149254085, 1.9970868834841 ], [ 1.3199668266287, 0.22575430310018 ], [ 1.610578345128, 0.98170193302041 ], [ 2.3500832868299, -1.3821760587532 ], [ 0.60115082922619, 0.35160088592206 ], [ 1.3919521135437, -5.336979406424 ], [ 0.93782078740059, 1.3830068336921 ], [ 1.0521670480275, -1.7597206921067 ], [ 2.1395572578955, 0.40793902142051 ] ];
	}

	test_mfcc {
		var condition = Condition();
		var audiofile = File.realpath(FluidBufPitch.class.filenameSymbol).dirname +/+ "../AudioFiles/Tremblay-ASWINE-ScratchySynth-M.wav";
		var raw = FluidDataSet(server);
		var standardized = FluidDataSet(server);
		var reduced = FluidDataSet(server);
		var audio = Buffer.read(server,audiofile);
		var mfcc_feature = Buffer.new(server);
		var stats_buf = Buffer.alloc(server, 7, 12);
		var datapoint = Buffer.alloc(server, 12);
		var standardizer  = FluidStandardize(server);
		var pca = FluidPCA(server,2);

		var synth;

		var reducedarray;

		server.sync;

		//run mfcc
		FluidBufMFCC.process(server,audio, features: mfcc_feature).wait;

		server.sync;

		//run synth
		synth = {
			var trig = LocalIn.kr(1, 1);
			var buf =  LocalBuf(12, 1);
			var count = PulseCount.kr(trig) - 1;
			var chunkLen = (mfcc_feature.numFrames / 100).asInteger;
			var stats = FluidBufStats.kr(
				source: mfcc_feature, startFrame: count * chunkLen,
				startChan: 1, numFrames: chunkLen, stats: stats_buf,
				trig: trig * (count < 100), blocking: 1
			);
			var rd = BufRd.kr(12, stats_buf, DC.kr(0), 0, 1);
			var bufWr, dsWr;
			12.do{|i|
				bufWr = BufWr.kr(rd[i], buf, DC.kr(i));
			};
			dsWr = FluidDataSetWr.kr(raw, buf: buf, idNumber: count, trig: Done.kr(stats));
			LocalOut.kr( Done.kr(dsWr));
			FreeSelf.kr(count - 99);
			Poll.kr(trig,(100 - count));
		}.play(server);

		synth.onFree({ condition.unhang });

		"TestFluidPCA: Stats processing. This can take some time...".warn;

		condition.hang;

		reducedarray = Array.new(100);
		standardizer.fitTransform(raw, standardized);
		pca.fitTransform(standardized, reduced, action:{|x|
			x.postln;
			result[\variance] = TestResultEquals(x.asFloat, 0.56128084659576, 0.0001);
			reduced.dump{|x|
				var data = x["data"];
				data.postln;
				result[\pca_size] = TestResult(data.size, 100);
				100.do{|i|
					reducedarray = reducedarray.add(data[i.asString])
				};
				condition.unhang;
			};
		});

		condition.hang;

		result[\reducedarray] = TestResultEquals(reducedarray, reducedarray_target, 0.0001);

		server.sync;
		raw.free;
		standardized.free;
		reduced.free;
		standardizer.free;
		pca.free;
	}
}